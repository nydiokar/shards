# Pipelight Pipeline: Swab the Deck with Free-Tier AI
## Scheduled Hecke-Maass Sharding + AI Analysis

triggers:
  - name: daily_swab
    cron: "0 2 * * *"  # 2 AM daily
  - name: on_push
    branch: main

pipelines:
  swab_deck:
    steps:
      - name: swab_rust
        commands:
          - cd swab-deck && cargo run --release -- all
      
      - name: analyze_with_gemini
        commands:
          - nix develop .#gemini-cli -c gemini-analyze-shards
      
      - name: analyze_with_claude
        commands:
          - nix develop .#claude-cli -c claude-analyze-shards
      
      - name: analyze_with_gpt
        commands:
          - nix develop .#openai-cli -c gpt-analyze-shards
      
      - name: analyze_with_llama
        commands:
          - nix develop .#ollama -c ollama-analyze-shards
      
      - name: consensus
        commands:
          - python3 ai_consensus.py
      
      - name: commit_results
        commands:
          - git add HECKE_MAASS_MANIFEST.json AI_ANALYSIS.json
          - git commit -m "chore: swab deck $(date +%Y-%m-%d)" || true
          - git push || true
  
  moltbook_register:
    steps:
      - name: generate_post
        commands:
          - python3 generate_moltbook_post.py
      
      - name: generate_zkperf_flakes
        commands:
          - bash generate_zkperf_flakes.sh
      
      - name: register_shard_0_zkperf
        commands:
          - echo "Registering Shard 0 with zkPerf witness..."
          - cd shard-0/openclaw && nix run --impure || echo "OpenClaw requires authentication"
      
      - name: register_shard_27_zkperf
        commands:
          - echo "Registering Shard 27 with zkPerf witness..."
          - cd shard-27/openclaw && nix run --impure || echo "OpenClaw requires authentication"
      
      - name: register_shard_70_zkperf
        commands:
          - echo "Registering Shard 70 with zkPerf witness..."
          - cd shard-70/openclaw && nix run --impure || echo "OpenClaw requires authentication"
      
      - name: collect_witnesses
        commands:
          - echo "Collecting zkPerf witnesses..."
          - jq -s '.' ~/.openclaw/shard-*/zkwitness-*.json > zkperf_witnesses.json 2>/dev/null || echo "No witnesses yet"
          - ls -lh ~/.openclaw/shard-*/zkperf-*.data 2>/dev/null || echo "No perf data yet"
      
      - name: status_report
        commands:
          - python3 check_moltbook_status.py
      
      - name: instructions
        commands:
          - echo "═══════════════════════════════════════════════════════════"
          - echo "ZKPERF WITNESS SYSTEM"
          - echo "═══════════════════════════════════════════════════════════"
          - echo ""
          - echo "✓ 71 zkPerf-wrapped flakes generated"
          - echo "✓ Each execution wrapped in perf record"
          - echo "✓ Witnesses: ~/.openclaw/shard-N/zkwitness-N.json"
          - echo "✓ Perf data: ~/.openclaw/shard-N/zkperf-N.data"
          - echo ""
          - echo "Integration: https://github.com/meta-introspector/zkperf"
          - echo ""
          - echo "To register all 71 shards with zkPerf:"
          - echo "  for i in {0..70}; do"
          - echo "    cd shard-\$i/openclaw && nix run --impure"
          - echo "  done"
          - echo ""
          - echo "Verify witnesses:"
          - echo "  jq -s '.' ~/.openclaw/shard-*/zkwitness-*.json"
          - echo "═══════════════════════════════════════════════════════════"

options:
  detach: false
  log_level: info
